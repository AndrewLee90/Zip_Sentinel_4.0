<?php
/**
 * Plugin Name: Malware Detection Board
 * Description: ì•…ì„±ì½”ë“œ ê²€ì‚¬ API ì—°ë™ ì›¹ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ
 * Version: 1.0.0
 * Author: Custom
 */

// ì§ì ‘ ì ‘ê·¼ ë°©ì§€
if (!defined('ABSPATH')) {
    exit;
}

// íŒŒì¼ ì—…ë¡œë“œ ì œí•œ ì„¤ì •
@ini_set('upload_max_filesize', '2048M');
@ini_set('post_max_size', '2048M');
@ini_set('memory_limit', '3072M');
@ini_set('max_execution_time', '1200');
@ini_set('max_input_time', '1200');

// í•„ìˆ˜ íŒŒì¼ë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
$required_files = array(
    plugin_dir_path(__FILE__) . 'includes/class-api-handler.php',
    plugin_dir_path(__FILE__) . 'includes/class-admin-page.php',
    plugin_dir_path(__FILE__) . 'includes/hooks.php'
);

$missing_files = array();
foreach ($required_files as $file) {
    if (!file_exists($file)) {
        $missing_files[] = basename($file);
    }
}

if (!empty($missing_files)) {
    add_action('admin_notices', function() use ($missing_files) {
        echo '<div class="notice notice-error"><p>';
        echo '<strong>Malware Detection Board:</strong> ë‹¤ìŒ íŒŒì¼ë“¤ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' . implode(', ', $missing_files);
        echo '</p></div>';
    });
    return;
}

// íŒŒì¼ë“¤ ë¡œë“œ
require_once plugin_dir_path(__FILE__) . 'includes/class-api-handler.php';
require_once plugin_dir_path(__FILE__) . 'includes/class-admin-page.php';
require_once plugin_dir_path(__FILE__) . 'includes/hooks.php';

// ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ í•¨ìˆ˜
function mdb_write_log($message) {
    if (defined('WP_DEBUG') && WP_DEBUG === true) {
        if (is_array($message) || is_object($message)) {
            error_log('[MDB] ' . print_r($message, true));
        } else {
            error_log('[MDB] ' . $message);
        }
    }
}

function create_malware_board_table() {
    global $wpdb;
    $charset_collate = $wpdb->get_charset_collate();
    $table_name = $wpdb->prefix . 'malware_board';
    
    // 1. ë¨¼ì € ê¸°ë³¸ í…Œì´ë¸” ìƒì„± (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
    $sql = "CREATE TABLE IF NOT EXISTS {$table_name} (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        title varchar(255) NOT NULL,
        content longtext NOT NULL,
        author bigint(20) NOT NULL,
        file_url varchar(255),
        file_name varchar(255),
        status varchar(20) NOT NULL DEFAULT 'pending',
        malware_score int(11) DEFAULT 0,
        malware_status varchar(20) DEFAULT 'pending',
        malware_details longtext,
        block_reason varchar(500),
        detected_items longtext,
        malicious_file_count int(11) DEFAULT 0,
        total_file_count int(11) DEFAULT 0,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        KEY author (author),
        KEY status (status),
        KEY malware_status (malware_status)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
    
    // 2. ê¸°ì¡´ ì»¬ëŸ¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    $existing_columns = $wpdb->get_col("DESCRIBE {$table_name}");
    
    // 3. í•„ìš”í•œ ì»¬ëŸ¼ë“¤ ì¶”ê°€
    $columns_to_add = array(
        'malware_score' => "ALTER TABLE {$table_name} ADD COLUMN malware_score int(11) DEFAULT 0",
        'malware_status' => "ALTER TABLE {$table_name} ADD COLUMN malware_status varchar(20) DEFAULT 'pending'",
        'malware_details' => "ALTER TABLE {$table_name} ADD COLUMN malware_details longtext",
        'block_reason' => "ALTER TABLE {$table_name} ADD COLUMN block_reason varchar(500)",
        'detected_items' => "ALTER TABLE {$table_name} ADD COLUMN detected_items longtext",
        'malicious_file_count' => "ALTER TABLE {$table_name} ADD COLUMN malicious_file_count int(11) DEFAULT 0",
        'total_file_count' => "ALTER TABLE {$table_name} ADD COLUMN total_file_count int(11) DEFAULT 0"
    );
    
    foreach ($columns_to_add as $column_name => $sql) {
        if (!in_array($column_name, $existing_columns)) {
            $result = $wpdb->query($sql);
            if ($result === false) {
                mdb_write_log("ì»¬ëŸ¼ ì¶”ê°€ ì‹¤íŒ¨: {$column_name} - " . $wpdb->last_error);
            } else {
                mdb_write_log("ì»¬ëŸ¼ ì¶”ê°€ ì„±ê³µ: {$column_name}");
            }
        }
    }
    
    // 4. í…Œì´ë¸” ë²„ì „ ì €ì¥
    update_option('malware_board_table_version', '1.0');
    
    mdb_write_log("ì•…ì„±ì½”ë“œ ê²€ì‚¬ ê²Œì‹œíŒ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ (v1.0)");
}

// í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”ì‹œ í…Œì´ë¸” ìƒì„±/ì—…ë°ì´íŠ¸
register_activation_hook(__FILE__, 'create_malware_board_table');

// í”ŒëŸ¬ê·¸ì¸ ë¡œë“œì‹œì—ë„ í…Œì´ë¸” ë²„ì „ ì²´í¬
add_action('plugins_loaded', 'check_malware_board_table_version');

function check_malware_board_table_version() {
    $current_version = get_option('malware_board_table_version', '1.0');
    $required_version = '1.0';
    
    // ë²„ì „ì´ ë‚®ìœ¼ë©´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    if (version_compare($current_version, $required_version, '<')) {
        mdb_write_log("í…Œì´ë¸” ë²„ì „ ì—…ë°ì´íŠ¸ í•„ìš”: {$current_version} -> {$required_version}");
        create_malware_board_table();
    }
}

function mdb_init() {
    // ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™”
    if (is_admin()) {
        MalwareBoardAdminPage::init();
    }
    // í›„í‚¹ ì´ˆê¸°í™”
    MDBHooks::init();
}
add_action('plugins_loaded', 'mdb_init');

// í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”ì‹œ ê¸°ë³¸ ì„¤ì •
register_activation_hook(__FILE__, 'mdb_activate');
function mdb_activate() {
    // ê¸°ë³¸ ì„¤ì •ê°’ ì¶”ê°€
    add_option('mdb_auto_send', 1);
    add_option('mdb_api_endpoint', '');
    add_option('mdb_api_key', '');
    add_option('mdb_safe_threshold', 2);
    add_option('mdb_warning_threshold', 6);
    add_option('mdb_admin_notifications', 1);
    add_option('mdb_retry_attempts', 3);
    
    // í…Œì´ë¸” ìƒì„±
    create_malware_board_table();
}

// í”ŒëŸ¬ê·¸ì¸ ë¹„í™œì„±í™”ì‹œ ì •ë¦¬
register_deactivation_hook(__FILE__, 'mdb_deactivate');
function mdb_deactivate() {
    // cron job ì •ë¦¬
    wp_clear_scheduled_hook('mdb_retry_analysis');
    wp_clear_scheduled_hook('mdb_check_api_result');
}

// íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
function handle_malware_board_file_upload() {
    if (empty($_FILES['file']['name'])) {
        return array('url' => '', 'name' => '');
    }

    if ($_FILES['file']['error'] !== UPLOAD_ERR_OK) {
        $error_code = $_FILES['file']['error'];
        mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜ ì½”ë“œ: $error_code");
        return new WP_Error('upload_error', 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜ ì½”ë“œ: ' . $error_code);
    }

    $max_upload = min((int)ini_get('upload_max_filesize'), (int)ini_get('post_max_size'));
    $max_size = $max_upload * 1024 * 1024;

    if ($_FILES['file']['size'] > $max_size) {
        return new WP_Error('file_too_large',
            sprintf('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. %dMB ì´í•˜ì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', $max_upload));
    }

    $upload_dir = wp_upload_dir();
    $board_upload_dir = $upload_dir['basedir'] . '/malware-board-uploads';
    if (!file_exists($board_upload_dir)) {
        wp_mkdir_p($board_upload_dir);
    }

    $blocked_types = ['php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'asp', 'aspx',
                      'jsp', 'jspx', 'htaccess', 'htpasswd', 'config', 'conf', 'ini', 'dll', 
                      'so', 'exe', 'msi', 'bat', 'cmd', 'sh', 'bash'];

    $file_info = wp_check_filetype($_FILES['file']['name']);
    $file_ext = strtolower($file_info['ext']);

    if (in_array($file_ext, $blocked_types)) {
        return new WP_Error('invalid_file_type', 'ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ í•´ë‹¹ íŒŒì¼ í˜•ì‹ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    require_once(ABSPATH . 'wp-admin/includes/file.php');
    $upload_overrides = array(
        'test_form' => false,
        'unique_filename_callback' => function($dir, $name, $ext) {
            $prefix = substr(md5(uniqid()), 0, 8);
            return $prefix . '-' . $name . $ext;
        }
    );

    set_time_limit(0);
    wp_raise_memory_limit('admin');

    mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì‹œë„: " . $_FILES['file']['name'] . " (" . $_FILES['file']['size'] . " bytes)");

    $movefile = wp_handle_upload($_FILES['file'], $upload_overrides);

    if ($movefile && !isset($movefile['error'])) {
        mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ: " . print_r($movefile, true));
        return array(
            'url' => $movefile['url'],
            'name' => basename($_FILES['file']['name']),
            'size' => $_FILES['file']['size']
        );
    } else {
        mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " . print_r($movefile['error'], true));
        return new WP_Error('upload_error', $movefile['error']);
    }
}

// ê²Œì‹œê¸€ ì‘ì„± í¼
function malware_board_write_form() {
    if (!is_user_logged_in()) {
        return '<div class="board-message">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
    }
    set_time_limit(0);
    ini_set('max_execution_time', 0);
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'save_malware_board') {
        // ì¶”ê°€ ë¡œê¹…
        mdb_write_log("í¼ ì œì¶œ ì‹œì‘");
        mdb_write_log("íŒŒì¼ ì •ë³´: " . print_r($_FILES, true));
        
        if (!wp_verify_nonce($_POST['board_nonce'], 'save_malware_board_nonce')) {
            mdb_write_log("Nonce ê²€ì¦ ì‹¤íŒ¨");
            return '<div class="board-message error">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>';
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        $file_data = array('url' => '', 'name' => '');
        if (!empty($_FILES['file']['name'])) {
            mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì‹œë„");
            $upload_result = handle_malware_board_file_upload();
            
            // ì¶”ê°€ ë¡œê¹…
            if (is_wp_error($upload_result)) {
                mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " . $upload_result->get_error_message());
                return '<div class="board-message error">' . $upload_result->get_error_message() . '</div>';
            }
            
            $file_data = $upload_result;
            mdb_write_log("íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ: " . print_r($file_data, true));
        }
        
        global $wpdb;
        
        // ì¶”ê°€ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ prepare() ì‚¬ìš©
        $data = array(
            'title' => sanitize_text_field($_POST['title']),
            'content' => wp_kses_post($_POST['content']),
            'author' => get_current_user_id(),
            'file_url' => $file_data['url'],
            'file_name' => $file_data['name'],
            'status' => 'private', 
            'malware_status' => 'pending'
        );
        
        // prepare() ë©”ì„œë“œ ì‚¬ìš©
        $insert_result = $wpdb->insert(
            "{$wpdb->prefix}malware_board", 
            $data,
            ['%s', '%s', '%d', '%s', '%s', '%s', '%s']
        );
        
        // ì‚½ì… ê²°ê³¼ ë¡œê¹…
        if ($insert_result === false) {
            mdb_write_log("ê²Œì‹œê¸€ ì €ì¥ ì‹¤íŒ¨: " . $wpdb->last_error);
            return '<div class="board-message error">ê²Œì‹œê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
        
        $post_id = $wpdb->insert_id;
        mdb_write_log("ê²Œì‹œê¸€ ì €ì¥ ì„±ê³µ. ID: {$post_id}");
        
        $url = home_url("/?action=view&id={$post_id}");
        
        // ì¦‰ì‹œ ì•…ì„±ì½”ë“œ ê²€ì‚¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
        if (get_option('mdb_auto_send', 1)) {
            mdb_write_log("ì•…ì„±ì½”ë“œ ê²€ì‚¬ ì‹œì‘");
            execute_malware_analysis($post_id, $url);
        } else {
            // ìë™ ê²€ì‚¬ê°€ ë¹„í™œì„±í™”ëœ ê²½ìš° ì¦‰ì‹œ ê³µê°œ
            $wpdb->update(
                "{$wpdb->prefix}malware_board",
                array('status' => 'public', 'malware_status' => 'skipped'),
                array('id' => $post_id)
            );
        }
        
        return '<div class="board-message success">ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì•…ì„±ì½”ë“œ ê²€ì‚¬ í›„ ê³µê°œë©ë‹ˆë‹¤.</div>';
    }
    
    ob_start();
    ?>
    <div class="board-form-container">
        <h2>ê²Œì‹œê¸€ ì‘ì„±</h2>
        <form method="post" enctype="multipart/form-data" class="board-form">
            <input type="hidden" name="action" value="save_malware_board">
            <?php wp_nonce_field('save_malware_board_nonce', 'board_nonce'); ?>
            
            <div class="form-group">
                <label for="title">ì œëª©</label>
                <input type="text" name="title" id="title" required>
            </div>
            
            <div class="form-group">
                <label for="content">ë‚´ìš©</label>
                <?php 
                wp_editor('', 'content', array(
                    'media_buttons' => true,
                    'textarea_name' => 'content',
                    'textarea_rows' => 10,
                    'teeny' => true
                ));
                ?>
            </div>
            
            <div class="form-group">
                <label for="file">ì²¨ë¶€íŒŒì¼</label>
                <input type="file" name="file" id="file">
                <small>ìµœëŒ€ 2048MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="submit-btn">ê²Œì‹œí•˜ê¸°</button>
                <a href="?action=list" class="cancel-btn">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>
    
    <div class="malware-notice">
        <p><small>ğŸ” ì•…ì„±ì½”ë“œ ìë™ ê²€ì‚¬ ì•ˆë‚´: ê²Œì‹œê¸€ ë“±ë¡ í›„ ìë™ìœ¼ë¡œ ì•…ì„±ì½”ë“œ ê²€ì‚¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</small></p>
        <ul>
            <li><strong>ì–‘í˜¸:</strong> ì¦‰ì‹œ ê³µê°œ</li>
            <li><strong>ì£¼ì˜:</strong> ê³µê°œë˜ì§€ë§Œ ì£¼ì˜ í‘œì‹œ</li>
            <li><strong>ê²½ê³ :</strong> ë¹„ê³µê°œ ì²˜ë¦¬</li>
        </ul>
    </div>
    <?php
    return ob_get_clean();
}

function microtime_float() {
    list($usec, $sec) = explode(" ", microtime());
    return ((float)$usec + (float)$sec);
}

function execute_malware_analysis($post_id, $url) {
    // ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì‹œê°„ ì¸¡ì •
    $start_total_time = microtime_float();
    mdb_write_log("ğŸ•’ ê²Œì‹œê¸€ ID {$post_id} ì•…ì„±ì½”ë“œ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì‹œì‘");

    // API ì„¤ì • í™•ì¸ ì‹œê°„ ì¸¡ì •
    $start_api_prep_time = microtime_float();
    $api_endpoint = get_option('mdb_api_endpoint');
    $api_key = get_option('mdb_api_key');

    if (empty($api_endpoint)) {
        mdb_write_log("âŒ ê²Œì‹œê¸€ ID {$post_id} - API ì—”ë“œí¬ì¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ");
        $api_prep_time = microtime_float() - $start_api_prep_time;
        mdb_write_log("ğŸ•’ API ì¤€ë¹„ ì†Œìš” ì‹œê°„: {$api_prep_time}ì´ˆ");

        global $wpdb;
        $wpdb->update(
            "{$wpdb->prefix}malware_board",
            [
                'status' => 'private',
                'malware_status' => 'skipped',
                'malware_score' => 0,
                'malicious_file_count' => 0,
                'total_file_count' => 0
            ],
            ['id' => $post_id]
        );
        return;
    }

    // ê²Œì‹œê¸€ ì¡°íšŒ ì‹œê°„ ì¸¡ì •
    $start_post_fetch_time = microtime_float();
    global $wpdb;
    $post = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}malware_board WHERE id = %d", $post_id
    ));

    if (!$post) {
        mdb_write_log("âŒ ê²Œì‹œê¸€ ID {$post_id}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
        $post_fetch_time = microtime_float() - $start_post_fetch_time;
        mdb_write_log("ğŸ•’ ê²Œì‹œê¸€ ì¡°íšŒ ì†Œìš” ì‹œê°„: {$post_fetch_time}ì´ˆ");
        return;
    }

    $post_fetch_time = microtime_float() - $start_post_fetch_time;
    mdb_write_log("ğŸ•’ ê²Œì‹œê¸€ ì¡°íšŒ ì†Œìš” ì‹œê°„: {$post_fetch_time}ì´ˆ");

    // íŒŒì¼ í¬ê¸° ë¡œê¹…
    $file_size = $post->file_url ? 
        filesize(str_replace(wp_upload_dir()['baseurl'], wp_upload_dir()['basedir'], $post->file_url)) : 
        0;

    mdb_write_log("ğŸ“Š íŒŒì¼ í¬ê¸°: {$file_size} bytes");
    mdb_write_log("ğŸ“Š íŒŒì¼ URL: {$post->file_url}");

    // API ìš”ì²­ ì¤€ë¹„ ì‹œê°„ ì¸¡ì •
    $start_api_request_prep_time = microtime_float();
    $headers = array('Content-Type' => 'application/json');
    if (!empty($api_key)) {
        $headers['Authorization'] = 'Bearer ' . $api_key;
    }

    $post_text = $post->title . "\n\n" . strip_tags($post->content);
    $download_link = !empty($post->file_url) ? $post->file_url : '';

    $post_data = array(
        'post_id' => $post_id,
        'post_text' => $post_text,
        'download_link' => $download_link,
        'file_size' => $file_size  // íŒŒì¼ í¬ê¸° ì¶”ê°€
    );

    $args = array(
        'method' => 'POST',
        'headers' => $headers,
        'body' => json_encode($post_data),
        'timeout' => 300,  // 5ë¶„ìœ¼ë¡œ ëŠ˜ë¦¼
        'blocking' => true
    );
    $api_request_prep_time = microtime_float() - $start_api_request_prep_time;
    mdb_write_log("ğŸ•’ API ìš”ì²­ ì¤€ë¹„ ì†Œìš” ì‹œê°„: {$api_request_prep_time}ì´ˆ");

    // API ìš”ì²­ ì „ì†¡ ì‹œê°„ ì¸¡ì •
    $start_api_send_time = microtime_float();
    mdb_write_log("ğŸ“¤ API ìš”ì²­ ì „ì†¡ ì¤‘ - ê²Œì‹œê¸€ ID: {$post_id}");
    mdb_write_log("ğŸŒ API ì—”ë“œí¬ì¸íŠ¸: {$api_endpoint}");
    
    // API ìš”ì²­ ì„¸ë¶€ ì •ë³´ ë¡œê¹…
    mdb_write_log("ğŸ•’ API ìš”ì²­ ì „ì†¡ ì„¸ë¶€ ì •ë³´", [
        'file_size' => $file_size,
        'file_url' => $post->file_url,
        'post_id' => $post_id,
        'api_endpoint' => $api_endpoint
    ]);

    $response = wp_remote_post($api_endpoint, $args);
    $api_send_time = microtime_float() - $start_api_send_time;
    mdb_write_log("ğŸ•’ API ìš”ì²­ ì „ì†¡ ì†Œìš” ì‹œê°„: {$api_send_time}ì´ˆ");

    // API ì‘ë‹µ ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
    $start_api_response_time = microtime_float();
    if (is_wp_error($response)) {
        mdb_write_log("âŒ API ìš”ì²­ ì˜¤ë¥˜: " . $response->get_error_message());
        $wpdb->update("{$wpdb->prefix}malware_board", ['malware_status' => 'failed'], ['id' => $post_id]);
        $api_response_time = microtime_float() - $start_api_response_time;
        mdb_write_log("ğŸ•’ API ì‘ë‹µ ì²˜ë¦¬ ì†Œìš” ì‹œê°„: {$api_response_time}ì´ˆ");
        return;
    }

    $code = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    mdb_write_log("ğŸ“¥ API ì‘ë‹µ ì½”ë“œ: {$code}");
    mdb_write_log("ğŸ“„ ì‘ë‹µ ë‚´ìš©: {$body}");

    if ($code === 200) {
        $result = json_decode($body, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            mdb_write_log("âŒ JSON íŒŒì‹± ì˜¤ë¥˜");
            $wpdb->update("{$wpdb->prefix}malware_board", ['malware_status' => 'failed'], ['id' => $post_id]);
            $api_response_time = microtime_float() - $start_api_response_time;
            mdb_write_log("ğŸ•’ API ì‘ë‹µ ì²˜ë¦¬ ì†Œìš” ì‹œê°„: {$api_response_time}ì´ˆ");
            return;
        }

        process_malware_analysis_result(
            $post_id,
            intval($result['malicious_count'] ?? 0),
            $result['risk_level_readable'] ?? '',
            $result
        );
    } else {
        $wpdb->update("{$wpdb->prefix}malware_board", ['malware_status' => 'failed'], ['id' => $post_id]);
        mdb_write_log("âŒ API ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬ë¨");
    }

    $api_response_time = microtime_float() - $start_api_response_time;
    mdb_write_log("ğŸ•’ API ì‘ë‹µ ì²˜ë¦¬ ì†Œìš” ì‹œê°„: {$api_response_time}ì´ˆ");

    // ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì†Œìš” ì‹œê°„ ê³„ì‚°
    $total_time = microtime_float() - $start_total_time;
    mdb_write_log("ğŸ•’ ê²Œì‹œê¸€ ID {$post_id} ì „ì²´ ì•…ì„±ì½”ë“œ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì†Œìš” ì‹œê°„: {$total_time}ì´ˆ");
}

// ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
function update_malware_analysis_status($post_id, $status, $message) {
    global $wpdb;
    
    $wpdb->update(
        "{$wpdb->prefix}malware_board",
        [
            'malware_status' => $status,
            'malware_details' => $message
        ],
        ['id' => $post_id]
    );
    
    mdb_write_log("ê²Œì‹œê¸€ ID {$post_id} ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸: {$status} - {$message}");
}
// API ê²°ê³¼ í™•ì¸ í•¨ìˆ˜ (cron hookì—ì„œ í˜¸ì¶œ)
function check_malware_api_result($post_id) {
    mdb_write_log("ê²Œì‹œê¸€ ID {$post_id} - API ê²°ê³¼ í™•ì¸ ì‹œì‘");
    
    // API Handlerë¥¼ í†µí•´ ê²°ê³¼ ì¡°íšŒ
    $result = MDBApiHandler::get_malware_analysis_result($post_id);
    
    if ($result && isset($result['malware_score'])) {
        $malware_score = intval($result['malware_score']);
        $details = isset($result['details']) ? $result['details'] : '';
        
        // ê¸°ë³¸ê°’ ì¶”ê°€
        $items = [
            'malicious_count' => $result['malicious_count'] ?? 0,
            'total_files' => $result['total_files'] ?? 0,
            'risk_level' => $result['risk_level'] ?? 'ë¯¸ë¶„ì„',
            'risk_level_readable' => $result['risk_level_readable'] ?? 'ë¯¸ë¶„ì„',
            'vt_report_url' => $result['vt_report_url'] ?? ''
        ];

        process_malware_analysis_result(
            $post_id, 
            $malware_score, 
            $details, 
            $items
        );
    } else {
        // ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” APIì—ì„œ ê²°ê³¼ë¥¼ ë°›ì•„ì•¼ í•˜ì§€ë§Œ, 
        // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì„ì‹œ ëœë¤ ì ìˆ˜ ìƒì„±
        $malware_score = rand(0, 10);
        $details = "í…ŒìŠ¤íŠ¸ ë¶„ì„ ê²°ê³¼ - ì ìˆ˜: {$malware_score}";
        
        $items = [
            'malicious_count' => 0,
            'total_files' => 1,
            'risk_level' => 'ë¯¸ë¶„ì„',
            'risk_level_readable' => 'ë¯¸ë¶„ì„',
            'vt_report_url' => ''
        ];

        process_malware_analysis_result(
            $post_id, 
            $malware_score, 
            $details, 
            $items
        );
    }
}
add_action('mdb_check_api_result', 'check_malware_api_result');

// ì•…ì„±ì½”ë“œ ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
function process_malware_analysis_result($post_id, $malware_score, $details = '', $items = []) {
    global $wpdb;
    $table_name = $wpdb->prefix . 'malware_board';
    
    // ì¶”ê°€ ë¡œê¹…
    mdb_write_log("ğŸ“Š ì•…ì„±ì½”ë“œ ë¶„ì„ ê²°ê³¼ ìƒì„¸ ì •ë³´", [
        'post_id' => $post_id,
        'malware_score' => $malware_score,
        'details' => $details,
        'items' => $items
    ]);

    // risk_levelì„ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ê²°ì •
    $risk_level = $items['risk_level'] ?? 'ë¯¸ë¶„ì„';
    
    $malicious_count = $items['malicious_count'] ?? 0;
    $total_files = $items['total_files'] ?? 0;
    
    switch ($risk_level) {
        case 'ì–‘í˜¸':
        case 'ì£¼ì˜':
        case 'ë¯¸ë¶„ì„':
            $status = 'public';
            $malware_status = $risk_level === 'ì–‘í˜¸' ? 'safe' : 
                              ($risk_level === 'ì£¼ì˜' ? 'warning' : 'pending');
            $block_reason = $risk_level === 'ì£¼ì˜' ? 'ì£¼ì˜ ë“±ê¸‰ íŒŒì¼ í¬í•¨' : '';
            break;
        case 'ìœ„í—˜':
            $status = 'private';
            $malware_status = 'danger';
            $block_reason = 'ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ìœ„í—˜ ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë¨';
            break;
        default:
            $status = 'public';
            $malware_status = 'ë¯¸ë¶„ì„';
            $block_reason = 'ì•Œ ìˆ˜ ì—†ëŠ” ìœ„í—˜ ìˆ˜ì¤€';
    }
    
    $update_result = $wpdb->update($table_name, 
        [
            'status' => $status,
            'malware_status' => $malware_status,
            'malware_score' => $malware_score,
            'malware_details' => $details,
            'block_reason' => $block_reason,
            'detected_items' => json_encode($items),
            'malicious_file_count' => $malicious_count,
            'total_file_count' => $total_files
        ], 
        ['id' => $post_id]
    );

    // ì—…ë°ì´íŠ¸ ê²°ê³¼ ë¡œê¹…
    if ($update_result === false) {
        mdb_write_log("âŒ ê²Œì‹œê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " . $wpdb->last_error);
    } else {
        mdb_write_log("âœ… ê²Œì‹œê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }
    
    // VirusTotal ë¦¬í¬íŠ¸ URL ë¡œê¹… (ì˜µì…˜)
    if (isset($items['vt_report_url'])) {
        mdb_write_log("ğŸŒ VirusTotal ë¦¬í¬íŠ¸ URL: " . $items['vt_report_url']);
    }
    
    mdb_write_log("ğŸ“Š ê²Œì‹œê¸€ ID {$post_id} ì²˜ë¦¬ ê²°ê³¼", [
        'ìƒíƒœ' => $status,
        'ì•…ì„±ì½”ë“œ ìƒíƒœ' => $malware_status,
        'ì•…ì„± íŒŒì¼ ìˆ˜' => $malicious_count,
        'ì „ì²´ íŒŒì¼ ìˆ˜' => $total_files
    ]);
}

// ì•…ì„±ì½”ë“œ ê°ì§€ ì•Œë¦¼ ì´ë©”ì¼
function send_malware_detection_email($post_id, $malware_score, $details) {
    if (!get_option('mdb_admin_notifications', 1)) {
        return;
    }
    
    $admin_email = get_option('admin_email');
    $site_name = get_bloginfo('name');
    $site_url = home_url();
    
    $subject = "[{$site_name}] ì•…ì„±ì½”ë“œ ê²½ê³  - ê²Œì‹œê¸€ ë¹„ê³µê°œ ì²˜ë¦¬";
    
    $message = "ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ìœ„í—˜í•œ íŒŒì¼ì´ ê°ì§€ë˜ì–´ ê²Œì‹œê¸€ì´ ë¹„ê³µê°œë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n";
    $message .= "ì‚¬ì´íŠ¸: {$site_name} ({$site_url})\n";
    $message .= "ê²Œì‹œê¸€ ID: {$post_id}\n";
    $message .= "ì•…ì„±ì½”ë“œ ì ìˆ˜: {$malware_score}/10\n";
    $message .= "ì„¸ë¶€ì‚¬í•­: {$details}\n\n";
    $message .= "ê²Œì‹œê¸€ í™•ì¸: " . home_url("/?action=view&id={$post_id}") . "\n";
    $message .= "ê´€ë¦¬ì í˜ì´ì§€: " . admin_url('tools.php?page=mdb-posts-management') . "\n\n";
    $message .= "ì´ ë©”ì¼ì€ ìë™ìœ¼ë¡œ ë°œì†¡ëœ ë©”ì¼ì…ë‹ˆë‹¤.";
    
    $headers = array('Content-Type: text/plain; charset=UTF-8');
    wp_mail($admin_email, $subject, $message, $headers);
    
    mdb_write_log("ê´€ë¦¬ì ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡: {$admin_email}");
}

// ê²Œì‹œê¸€ ëª©ë¡ í‘œì‹œ
function display_malware_board_list() {
    global $wpdb;
    
    $page = isset($_GET['bpage']) ? max(1, intval($_GET['bpage'])) : 1;
    $per_page = 15;
    $offset = ($page - 1) * $per_page;
    
    $search = isset($_GET['search']) ? sanitize_text_field($_GET['search']) : '';
    
    // ê¶Œí•œì— ë”°ë¥¸ WHERE ì ˆ êµ¬ì„±
    $where = array();
    $where_params = array();
    
    $current_user_id = get_current_user_id();
    
    if (current_user_can('edit_posts')) {
        // ê´€ë¦¬ìëŠ” ëª¨ë“  ê²Œì‹œê¸€ ë³¼ ìˆ˜ ìˆìŒ
        $where[] = "1=1";
    } else {
        // ì¼ë°˜ ì‚¬ìš©ìëŠ” ê³µê°œ ê²Œì‹œê¸€ê³¼ ìì‹ ì˜ ê²Œì‹œê¸€ë§Œ
        $where[] = "(status = 'public' OR (status IN ('private', 'pending') AND b.author = %d))";
        $where_params[] = $current_user_id;
    }
    
    if ($search) {
        $where[] = "(title LIKE %s OR content LIKE %s)";
        $where_params[] = "%{$search}%";
        $where_params[] = "%{$search}%";
    }
    
    $where_clause = !empty($where) ? "WHERE " . implode(" AND ", $where) : "";
    
    // ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ
    $total = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM {$wpdb->prefix}malware_board b " . $where_clause,
        $where_params
    ));
    
    // ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
    $posts = $wpdb->get_results($wpdb->prepare(
        "SELECT b.*, u.display_name as author_name 
        FROM {$wpdb->prefix}malware_board b 
        LEFT JOIN {$wpdb->users} u ON b.author = u.ID " .
        $where_clause . " ORDER BY b.created_at DESC LIMIT %d OFFSET %d",
        array_merge($where_params, array($per_page, $offset))
    ));

    ob_start();
    ?>
    <div class="board-list">
        <div class="board-search">
            <form method="get">
                <input type="hidden" name="action" value="list">
                <input type="text" name="search" value="<?php echo esc_attr($search); ?>" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button type="submit">ê²€ìƒ‰</button>
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="8%">ë²ˆí˜¸</th>
                    <th>ì œëª©</th>
                    <th width="15%">ì‘ì„±ì</th>
                    <th width="10%">ìƒíƒœ</th>
                    <th width="15%">ì‘ì„±ì¼</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($posts): ?>
                    <?php foreach ($posts as $post): ?>
                    <tr>
                        <td class="center"><?php echo $post->id; ?></td>
                        <td>
                            <a href="?action=view&id=<?php echo $post->id; ?>">
                                <?php echo esc_html($post->title); ?>
                                <?php echo $post->file_url ? ' <i class="file-icon">ğŸ“</i>' : ''; ?>
                            </a>
                            <?php
                            // ì•…ì„±ì½”ë“œ ìƒíƒœ í‘œì‹œ
                            if ($post->status === 'pending'):
                            ?>
                            <small class="malware-pending">(ê²€ì‚¬ì¤‘)</small>
                            <?php elseif ($post->malware_status === 'warning'): ?>
                            <small class="malware-warning">(ì£¼ì˜)</small>
                            <?php elseif ($post->malware_status === 'danger'): ?>
                            <small class="malware-danger">(ìœ„í—˜)</small>
                            <?php endif; ?>
                        </td>
                        <td class="center"><?php echo esc_html($post->author_name); ?></td>
                        <td class="center">
                            <?php
                            switch($post->status) {
                                case 'public':
                                    echo '<span class="status-public">ê³µê°œ</span>';
                                    break;
                                case 'private':
                                    echo '<span class="status-private">ë¹„ê³µê°œ</span>';
                                    // ì•…ì„±ì½”ë“œë¡œ ì¸í•œ ë¹„ê³µê°œì¸ì§€ í‘œì‹œ (ê´€ë¦¬ìë§Œ)
                                    if (current_user_can('edit_posts') && $post->malware_status === 'danger'):
                                    ?>
                                    <br><small class="malware-blocked">(ì•…ì„±ì½”ë“œ ê°ì§€)</small>
                                    <?php
                                    endif;
                                    break;
                                case 'pending':
                                    echo '<span class="status-pending">ê²€ì‚¬ì¤‘</span>';
                                    break;
                            }
                            ?>
                        </td>
                        <td class="center"><?php echo date('Y-m-d', strtotime($post->created_at)); ?></td>
                    </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="5" class="center">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
        
        <?php
        $total_pages = ceil($total / $per_page);
        if ($total_pages > 1):
        ?>
        <div class="pagination">
            <?php
            $start_page = max(1, $page - 4);
            $end_page = min($total_pages, $page + 4);
            
            if ($page > 1) {
                echo '<a href="?action=list&bpage=1' . ($search ? '&search=' . urlencode($search) : '') . '" class="page-nav">â—€â—€</a>';
                echo '<a href="?action=list&bpage=' . ($page - 1) . ($search ? '&search=' . urlencode($search) : '') . '" class="page-nav">â—€</a>';
            }
            
            for ($i = $start_page; $i <= $end_page; $i++) {
                echo '<a href="?action=list&bpage=' . $i . ($search ? '&search=' . urlencode($search) : '') . '"' . 
                     ($page == $i ? ' class="current"' : '') . '>' . $i . '</a>';
            }
            
            if ($page < $total_pages) {
                echo '<a href="?action=list&bpage=' . ($page + 1) . ($search ? '&search=' . urlencode($search) : '') . '" class="page-nav">â–¶</a>';
                echo '<a href="?action=list&bpage=' . $total_pages . ($search ? '&search=' . urlencode($search) : '') . '" class="page-nav">â–¶â–¶</a>';
            }
            ?>
        </div>
        <?php endif; ?>
        
        <?php if (is_user_logged_in()): ?>
        <div class="board-buttons">
            <a href="?action=write" class="write-btn">ê¸€ì“°ê¸°</a>
        </div>
        <?php endif; ?>
    </div>
    <?php
    return ob_get_clean();
}

// ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°
function display_malware_board_view() {
    if (!isset($_GET['id'])) {
        return '<div class="board-message">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>';
    }
    
    global $wpdb;
    $post = $wpdb->get_row($wpdb->prepare(
        "SELECT b.*, u.display_name as author_name 
        FROM {$wpdb->prefix}malware_board b 
        LEFT JOIN {$wpdb->users} u ON b.author = u.ID 
        WHERE b.id = %d",
        intval($_GET['id'])
    ));
    
    if (!$post) {
        return '<div class="board-message">ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // ì ‘ê·¼ ê¶Œí•œ ì²´í¬
    $current_user_id = get_current_user_id();
    
    if ($post->status === 'private') {
        if (!current_user_can('edit_posts') && $current_user_id != $post->author) {
            return '<div class="board-message">ì´ ê²Œì‹œê¸€ì€ ë¹„ê³µê°œì…ë‹ˆë‹¤.</div>';
        }
    }
    
    if ($post->status === 'pending') {
        if (!current_user_can('edit_posts') && $current_user_id != $post->author) {
            return '<div class="board-message">ì´ ê²Œì‹œê¸€ì€ í˜„ì¬ ì•…ì„±ì½”ë“œ ê²€ì‚¬ ì¤‘ì…ë‹ˆë‹¤.</div>';
        }
    }
    
    ob_start();
    ?>
    <div class="board-view">
        <h2><?php echo esc_html($post->title); ?></h2>
        <div class="meta">
            <span>ì‘ì„±ì: <?php echo esc_html($post->author_name); ?></span>
            <span>ì‘ì„±ì¼: <?php echo date('Y-m-d H:i', strtotime($post->created_at)); ?></span>
            <?php if ($post->updated_at != $post->created_at): ?>
            <span>ìˆ˜ì •ì¼: <?php echo date('Y-m-d H:i', strtotime($post->updated_at)); ?></span>
            <?php endif; ?>
            <span>ìƒíƒœ: 
                <?php
                switch($post->status) {
                    case 'public': echo '<span class="status-public">ê³µê°œ</span>'; break;
                    case 'private': echo '<span class="status-private">ë¹„ê³µê°œ</span>'; break;
                    case 'pending': echo '<span class="status-pending">ê²€ì‚¬ì¤‘</span>'; break;
                }
                ?>
            </span>
            <?php if ($post->malware_score > 0): ?>
            <span>ì•…ì„±ì½”ë“œ ì ìˆ˜: <?php echo $post->malware_score; ?>/10</span>
            <?php endif; ?>
        </div>
        
        <?php if ($post->status === 'public' && $post->malware_status === 'warning'): ?>
        <div class="malware-warning-info">
            <h4>âš ï¸ ì£¼ì˜</h4>
            <p>ì´ ê²Œì‹œê¸€ì€ ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ì£¼ì˜ ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. (ì ìˆ˜: <?php echo $post->malware_score; ?>/10)</p>
            <p>ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œ ì£¼ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            <?php if (!empty($post->malware_details)): ?>
            <p><strong>ì„¸ë¶€ì‚¬í•­:</strong> <?php echo esc_html($post->malware_details); ?></p>
            <?php endif; ?>
        </div>
        <?php endif; ?>
        
        <?php if ($post->status === 'private' && $post->malware_status === 'danger' && (current_user_can('edit_posts') || $current_user_id == $post->author)): ?>
        <div class="malware-danger-info">
            <h4>ğŸš« ê²½ê³  - ì•…ì„±ì½”ë“œ ê°ì§€</h4>
            <p>ì´ ê²Œì‹œê¸€ì€ ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ìœ„í—˜ ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ë¹„ê³µê°œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ì ìˆ˜: <?php echo $post->malware_score; ?>/10)</p>
            <?php if (!empty($post->malware_details)): ?>
            <p><strong>ì„¸ë¶€ì‚¬í•­:</strong> <?php echo esc_html($post->malware_details); ?></p>
            <?php endif; ?>
            <p><strong>ì°¨ë‹¨ ì‚¬ìœ :</strong> <?php echo esc_html($post->block_reason); ?></p>
            <p><small>íŒŒì¼ì„ ì œê±°í•˜ê±°ë‚˜ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ê²Œì‹œê¸€ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</small></p>
        </div>
        <?php endif; ?>
        
        <?php if ($post->status === 'pending'): ?>
        <div class="malware-pending-info">
            <h4>ğŸ” ì•…ì„±ì½”ë“œ ê²€ì‚¬ ì§„í–‰ ì¤‘</h4>
            <p>í˜„ì¬ ì´ ê²Œì‹œê¸€ì˜ ì•…ì„±ì½”ë“œ ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <p>ê²€ì‚¬ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ê³µê°œ ì—¬ë¶€ê°€ ê²°ì •ë©ë‹ˆë‹¤.</p>
        </div>
        <?php endif; ?>
        
        <div class="content">
            <?php echo wpautop($post->content); ?>
        </div>
        
        <?php if ($post->file_url): ?>
        <div class="attachment">
            <strong>ì²¨ë¶€íŒŒì¼:</strong>
            <a href="<?php echo esc_url($post->file_url); ?>" target="_blank">
                <?php echo esc_html($post->file_name ? $post->file_name : basename($post->file_url)); ?>
            </a>
            <?php if ($post->malware_status === 'warning'): ?>
            <p class="file-warning">âš ï¸ ì£¼ì˜: ì´ íŒŒì¼ì€ ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ì£¼ì˜ ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <?php elseif ($post->malware_status === 'danger'): ?>
            <p class="file-danger">ğŸš« ê²½ê³ : ì´ íŒŒì¼ì€ ì•…ì„±ì½”ë“œ ê²€ì‚¬ì—ì„œ ìœ„í—˜ ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <?php endif; ?>
        </div>
        <?php endif; ?>
        
        <div class="board-buttons">
            <a href="?action=list" class="list-btn">ëª©ë¡</a>
            <?php if (current_user_can('edit_posts') || get_current_user_id() == $post->author): ?>
                <a href="?action=edit&id=<?php echo $post->id; ?>" class="edit-btn">ìˆ˜ì •</a>
                <form method="post" class="delete-form" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <input type="hidden" name="action" value="delete_malware_board">
                    <input type="hidden" name="post_id" value="<?php echo $post->id; ?>">
                    <?php wp_nonce_field('delete_malware_board_nonce', 'delete_nonce'); ?>
                    <button type="submit" class="delete-btn">ì‚­ì œ</button>
                </form>
            <?php endif; ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

// ê²Œì‹œê¸€ ìˆ˜ì • í¼
function malware_board_edit_form() {
    if (!isset($_GET['id'])) {
        return '<div class="board-message">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>';
    }
    
    global $wpdb;
    $post = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}malware_board WHERE id = %d",
        intval($_GET['id'])
    ));
    
    if (!$post) {
        return '<div class="board-message">ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    
    if (!current_user_can('edit_posts') && get_current_user_id() != $post->author) {
        return '<div class="board-message">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'update_malware_board') {
        if (!wp_verify_nonce($_POST['board_nonce'], 'update_malware_board_nonce')) {
            return '<div class="board-message error">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>';
        }
        
        $data = array(
            'title' => sanitize_text_field($_POST['title']),
            'content' => wp_kses_post($_POST['content']),
            'status' => 'pending', // ìˆ˜ì • ì‹œ ë‹¤ì‹œ ê²€ì‚¬ ëŒ€ê¸°ë¡œ
            'malware_status' => 'pending',
            'malware_score' => 0,
            'malware_details' => '',
            'block_reason' => ''
        );

        // ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ìˆ˜ë™ ìƒíƒœ ì„¤ì •
        if (current_user_can('edit_posts') && isset($_POST['manual_status'])) {
            $manual_status = sanitize_text_field($_POST['manual_status']);
            if ($manual_status === 'force_private') {
                $data['status'] = 'private';
                $data['malware_status'] = 'manual';
                $data['block_reason'] = 'ê´€ë¦¬ìì— ì˜í•´ ìˆ˜ë™ ë¹„ê³µê°œ ì²˜ë¦¬';
            } elseif ($manual_status === 'force_public') {
                $data['status'] = 'public';
                $data['malware_status'] = 'manual';
            }
        }
        
        if (!empty($_FILES['file']['name'])) {
            $file_result = handle_malware_board_file_upload();
            if (is_wp_error($file_result)) {
                return '<div class="board-message error">' . $file_result->get_error_message() . '</div>';
            }

            // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
            if ($post->file_url) {
                $old_file_path = str_replace(wp_upload_dir()['baseurl'], wp_upload_dir()['basedir'], $post->file_url);
                if (file_exists($old_file_path)) {
                    unlink($old_file_path);
                }
            }

            $data['file_url'] = $file_result['url'];
            $data['file_name'] = $file_result['name'];
        }
        
        $wpdb->update("{$wpdb->prefix}malware_board", $data, array('id' => $post->id));
        
        // ìë™ ê²€ì‚¬ê°€ í™œì„±í™”ë˜ê³  ìˆ˜ë™ ì„¤ì •ì´ ì•„ë‹Œ ê²½ìš° ë‹¤ì‹œ ê²€ì‚¬
        if (get_option('mdb_auto_send', 1) && $data['malware_status'] === 'pending') {
            $url = home_url("/?action=view&id={$post->id}");
            execute_malware_analysis($post->id, $url);
        }
        
        // ìˆ˜ì • í›„ ìƒì„¸ë³´ê¸°ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        wp_redirect(add_query_arg(array('action' => 'view', 'id' => $post->id, 'updated' => '1')));
        exit;
    }
    
    ob_start();
    ?>
    <div class="board-form-container">
        <h2>ê²Œì‹œê¸€ ìˆ˜ì •</h2>
        <form method="post" enctype="multipart/form-data" class="board-form">
            <input type="hidden" name="action" value="update_malware_board">
            <?php wp_nonce_field('update_malware_board_nonce', 'board_nonce'); ?>
            
            <div class="form-group">
                <label for="title">ì œëª©</label>
                <input type="text" name="title" id="title" value="<?php echo esc_attr($post->title); ?>" required>
            </div>
            
            <div class="form-group">
                <label for="content">ë‚´ìš©</label>
                <?php 
                wp_editor($post->content, 'content', array(
                    'media_buttons' => true,
                    'textarea_name' => 'content',
                    'textarea_rows' => 10,
                    'teeny' => true
                ));
                ?>
            </div>

            <?php if (current_user_can('edit_posts')): ?>
            <div class="form-group">
                <label for="manual_status">ê´€ë¦¬ì ìˆ˜ë™ ì„¤ì •</label>
                <select name="manual_status" id="manual_status">
                    <option value="">ìë™ ê²€ì‚¬ ì‹¤í–‰</option>
                    <option value="force_public">ê°•ì œ ê³µê°œ (ê²€ì‚¬ ì•ˆí•¨)</option>
                    <option value="force_private">ê°•ì œ ë¹„ê³µê°œ</option>
                </select>
                <small>ê´€ë¦¬ìëŠ” ì•…ì„±ì½”ë“œ ê²€ì‚¬ ì—†ì´ ì§ì ‘ ê³µê°œ/ë¹„ê³µê°œë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
            </div>
            <?php endif; ?>
            
            <div class="form-group">
                <label for="file">ì²¨ë¶€íŒŒì¼</label>
                <?php if ($post->file_url): ?>
                <p>í˜„ì¬ íŒŒì¼: <a href="<?php echo esc_url($post->file_url); ?>" target="_blank">
                    <?php echo esc_html($post->file_name ? $post->file_name : basename($post->file_url)); ?>
                </a></p>
                <?php endif; ?>
                <input type="file" name="file" id="file">
                <small>ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ íŒŒì¼ì€ ì‚­ì œë©ë‹ˆë‹¤. (ìµœëŒ€ 2048MB)</small>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="submit-btn">ìˆ˜ì •í•˜ê¸°</button>
                <a href="?action=view&id=<?php echo $post->id; ?>" class="cancel-btn">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>
    <?php
    return ob_get_clean();
}

// ê²Œì‹œê¸€ ì‚­ì œ ì²˜ë¦¬
function handle_malware_board_delete() {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'delete_malware_board') {
        if (!wp_verify_nonce($_POST['delete_nonce'], 'delete_malware_board_nonce')) {
            wp_die('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
        }
        
        $post_id = intval($_POST['post_id']);
        global $wpdb;
        
        $post = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$wpdb->prefix}malware_board WHERE id = %d",
            $post_id
        ));
        
        if (!$post) {
            wp_die('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        if (!current_user_can('edit_posts') && get_current_user_id() != $post->author) {
            wp_die('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ì²¨ë¶€ íŒŒì¼ ì‚­ì œ
        if ($post->file_url) {
            $file_path = str_replace(wp_upload_dir()['baseurl'], wp_upload_dir()['basedir'], $post->file_url);
            if (file_exists($file_path)) {
                unlink($file_path);
            }
        }
        
        $wpdb->delete("{$wpdb->prefix}malware_board", array('id' => $post_id));
        
        wp_redirect(add_query_arg(array('action' => 'list', 'deleted' => '1')));
        exit;
    }
}
add_action('init', 'handle_malware_board_delete');

// CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
function add_malware_board_styles() {
    ?>
    <style>
        .malware-board-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .board-message {
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-align: center;
        }
        .board-message.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .board-message.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .status-public { color: #28a745; font-weight: bold; }
        .status-private { color: #6c757d; font-weight: bold; }
        .status-pending { color: #17a2b8; font-weight: bold; }
        .malware-pending { color: #17a2b8; font-style: italic; }
        .malware-warning { color: #ffc107; font-style: italic; }
        .malware-danger { color: #dc3545; font-style: italic; }
        .malware-blocked { color: #dc3545; font-style: italic; }
        
        .malware-notice {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
            border-left: 4px solid #6c757d;
        }
        .malware-notice ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .malware-warning-info {
            margin: 20px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            color: #856404;
        }
        .malware-warning-info h4 {
            margin-top: 0;
            color: #856404;
        }
        
        .malware-danger-info {
            margin: 20px 0;
            padding: 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
        }
        .malware-danger-info h4 {
            margin-top: 0;
            color: #721c24;
        }
        
        .malware-pending-info {
            margin: 20px 0;
            padding: 15px;
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            color: #0c5460;
        }
        .malware-pending-info h4 {
            margin-top: 0;
            color: #0c5460;
        }
        
        .file-warning {
            color: #856404;
            font-weight: bold;
            margin-top: 5px;
        }
        .file-danger {
            color: #721c24;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .board-form-container, .board-view, .board-list {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input[type="text"], .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
        }
        
        .board-search {
            margin-bottom: 20px;
            text-align: right;
        }
        .board-search input[type="text"] {
            padding: 6px;
            width: 200px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .board-search button {
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .board-list table {
            width: 100%;
            border-collapse: collapse;
            border-top: 2px solid #343a40;
        }
        .board-list th, .board-list td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .board-list th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .board-list td.center {
            text-align: center;
        }
        
        .file-icon {
            color: #6c757d;
            font-style: normal;
        }
        
        .pagination {
            margin: 20px 0;
            text-align: center;
        }
        .pagination a {
            display: inline-block;
            padding: 6px 12px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-decoration: none;
            color: #495057;
        }
        .pagination a.current {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination a.page-nav {
            background: #e9ecef;
        }
        
        .board-buttons {
            margin-top: 20px;
            text-align: right;
        }
        .write-btn, .list-btn, .edit-btn, .delete-btn, .submit-btn, .cancel-btn {
            display: inline-block;
            padding: 8px 16px;
            margin-left: 10px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .write-btn, .submit-btn { background: #007bff; color: white; }
        .list-btn, .cancel-btn { background: #6c757d; color: white; }
        .edit-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        .board-view .meta {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .board-view .meta span {
            display: inline-block;
            margin-right: 20px;
            color: #6c757d;
        }
        .board-view .content {
            min-height: 200px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .board-view .attachment {
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .delete-form {
            display: inline-block;
        }
    </style>
    <?php
}
add_action('wp_head', 'add_malware_board_styles');

// ë‹¨ì¶•ì½”ë“œ ë“±ë¡
function malware_board_shortcode($atts) {
    ob_start();
    
    $action = isset($_GET['action']) ? $_GET['action'] : 'list';
    
    echo '<div class="malware-board-wrap">';
    
    // ë©”ì‹œì§€ í‘œì‹œ
    if (isset($_GET['success'])) {
        echo '<div class="board-message success">ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
    }
    if (isset($_GET['updated'])) {
        echo '<div class="board-message success">ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
    }
    if (isset($_GET['deleted'])) {
        echo '<div class="board-message success">ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
    }
    
    switch ($action) {
        case 'write':
            echo malware_board_write_form();
            break;
        case 'view':
            echo display_malware_board_view();
            break;
        case 'edit':
            echo malware_board_edit_form();
            break;
        default:
            echo display_malware_board_list();
    }
    
    echo '</div>';
    
    return ob_get_clean();
}
add_shortcode('malware_board', 'malware_board_shortcode');